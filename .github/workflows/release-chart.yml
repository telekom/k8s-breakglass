name: Release Helm Chart (OCI)

on:
  push:
    branches:
      - deployment-testing
    paths:
      - 'charts/escalation-config/**'
      - '.github/workflows/release-chart.yml'

jobs:
  publish:
    name: Publish chart to ghcr
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package Helm chart
        run: |
          helm version
          helm dependency update charts/escalation-config || true
          helm package charts/escalation-config --destination /tmp/chartpkg

      - name: Push chart to ghcr (OCI)
        env:
          CHART_PKG: /tmp/chartpkg
          OCI_REG: ghcr.io/${{ github.repository_owner }}/helm-charts
        run: |
          set -e
          mkdir -p /tmp/oci-ctx
          # enable OCI experimental if older helm
          export HELM_EXPERIMENTAL_OCI=1
          for f in ${CHART_PKG}/*.tgz; do
            CHART_NAME=$(basename "$f" .tgz)
            CHART_VERSION=$(helm show chart "$f" | yq e '.version' -)
            echo "Pushing $f -> ${OCI_REG}/${CHART_NAME}:${CHART_VERSION}"
            helm push "$f" "oci://${OCI_REG}" --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}
          done

      - name: Push chart to Artifactory (OCI)
        env:
          CHART_PKG: /tmp/chartpkg
          ARTIFACTORY_URL: artifactory.devops.telekom.de
          ARTIFACTORY_REPO: cit-t-caas-oci/charts
        run: |
          set -e
          export HELM_EXPERIMENTAL_OCI=1
          # Perform a non-interactive registry login with helm (uses --password-stdin)
          echo "${{ secrets.AF_TOKEN }}" | helm registry login ${ARTIFACTORY_URL} --username "${{ secrets.AF_USER }}" --password-stdin
          for f in ${CHART_PKG}/*.tgz; do
            CHART_NAME=$(basename "$f" .tgz)
            CHART_VERSION=$(helm show chart "$f" | yq e '.version' -)
            echo "Pushing $f -> ${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}/${CHART_NAME}:${CHART_VERSION}"
            # push using the already authenticated registry session (no interactive prompt)
            helm push "$f" "oci://${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}"
          done

      - name: Output published chart refs
        run: |
          ls -la /tmp/chartpkg || true
          echo "Published to ghcr: ghcr.io/${{ github.repository_owner }}/helm-charts/"
