name: Helm CI

on:
  pull_request: {}
  push: {}
  release:
    types: [published]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  helm-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.16.0

      - name: Install kustomize
        run: |
          curl -sSL https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
          sudo mv kustomize /usr/local/bin/kustomize

      - name: Determine chart VERSION for this run
        id: version
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            # Use a semver-compatible pre-release: 0.0.0-pr-<number>-<shortsha>
            VERSION="0.0.0-pr-${{ github.event.number }}-${GITHUB_SHA:0:8}"
          elif [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            # Use release tag as chart version (assumed valid semver)
            VERSION="${{ github.event.release.tag_name }}"
          else
            # For other pushes use a 0.0.0-<shortsha> pre-release
            VERSION="0.0.0-${GITHUB_SHA:0:8}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Set VERSION=${VERSION}"

      - name: Update Chart.yaml versions (runtime only)
        run: |
          set -euo pipefail
          echo "Updating chart versions to $VERSION"
          mkdir -p ./.chart-packages
          for chart in charts/*/Chart.yaml; do
            echo "Updating $chart"
            sed -E -i "s/^version: .*/version: \"$VERSION\"/" "$chart"
          done
          git --no-pager diff -- charts || true

      - name: Helm lint (strict)
        run: |
          helm lint charts/* --strict

      - name: Helm template (minimal)
        run: |
          helm template breakglass-controller charts/breakglass-controller -f charts/breakglass-controller/test-values/values-minimal.yaml

      - name: Helm template (tls)
        run: |
          helm template breakglass-controller charts/breakglass-controller -f charts/breakglass-controller/test-values/values-tls.yaml

      - name: Helm package (verify)
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.chart-packages"
          for d in charts/*; do
            if [ -f "$d/Chart.yaml" ]; then
              helm dependency update "$d" || true
              helm package "$d" --version "$VERSION" --destination "$GITHUB_WORKSPACE/.chart-packages"
            fi
          done

      - name: List packaged charts (debug)
        run: |
          echo "Listing $GITHUB_WORKSPACE/.chart-packages"
          ls -la "$GITHUB_WORKSPACE/.chart-packages" || true

      - name: Upload packaged charts (artifact)
        if: ${{ github.event_name != 'release' }}
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-${{ env.VERSION }}
          path: ${{ github.workspace }}/.chart-packages/*.tgz

      - name: Publish packaged charts to GHCR (OCI)
        if: ${{ github.event_name == 'release' || github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
        env:
          CHART_PKG: ${{ github.workspace }}/.chart-packages
          OCI_REG: ghcr.io/${{ github.repository_owner }}/helm-charts
        run: |
          set -e
          mkdir -p /tmp/oci-ctx
          export HELM_EXPERIMENTAL_OCI=1
          echo "Logging in to GHCR"
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login -u "${{ github.actor }}" --password-stdin "ghcr.io"
          for f in ${CHART_PKG}/*.tgz; do
            CHART_NAME=$(basename "$f" .tgz)
            CHART_VERSION=$(helm show chart "$f" -o yaml | grep '^version:' | awk '{print $2}')
            echo "Pushing $f -> ${OCI_REG}/${CHART_NAME}:${CHART_VERSION}"
            helm push "$f" "oci://${OCI_REG}" --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} || true
          done

      - name: Publish packaged charts to Artifactory (OCI)
        if: ${{ github.event_name == 'release' || github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
        env:
          CHART_PKG: ${{ github.workspace }}/.chart-packages
          ARTIFACTORY_URL: artifactory.devops.telekom.de
          ARTIFACTORY_REPO: cit-t-caas-oci/charts/t-caas
        run: |
          set -e
          export HELM_EXPERIMENTAL_OCI=1
          echo "Logging in to Artifactory"
          echo "${{ secrets.AF_TOKEN }}" | helm registry login -u "${{ secrets.AF_USER }}" --password-stdin "${ARTIFACTORY_URL}" || true
          for f in ${CHART_PKG}/*.tgz; do
            CHART_NAME=$(basename "$f" .tgz)
            CHART_VERSION=$(helm show chart "$f" -o yaml | grep '^version:' | awk '{print $2}')
            echo "Pushing $f -> ${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}/${CHART_NAME}:${CHART_VERSION}"
            helm push "$f" "oci://${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}" || true
          done

      - name: Publish packaged charts to GitHub Release
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@v1
        with:
          files: ./.chart-packages/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
