name: Helm CI

on:
  pull_request: {}
  pull_request_target: {}
  push: {}
  release:
    types: [published]

permissions:
  contents: read
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
jobs:
  helm-checks:
    permissions:
      contents: write
      packages: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v3.16.0

      - name: Install kustomize
        env:
          KUSTOMIZE_VERSION: v5.6.0
        run: |
          set -euo pipefail
          echo "Installing kustomize ${KUSTOMIZE_VERSION}"
          ARCHIVE="kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          curl -L "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/${ARCHIVE}" -o "${ARCHIVE}"
          tar -xzf "${ARCHIVE}"
          sudo mv kustomize /usr/local/bin/kustomize
          kustomize version

      - name: Determine chart VERSION for this run
        id: version
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          case "${GITHUB_EVENT_NAME}" in
            pull_request|pull_request_target)
              # Use a semver-compatible pre-release: 0.0.0-pr<number>.<shortsha>
              # Format: dot separator between PR number and SHA (semver compliant)
              # Example: 0.0.0-pr123.a1b2c3d4
              VERSION="0.0.0-pr${{ github.event.number }}.${GITHUB_SHA:0:8}"
              ;;
            release)
              # Use release tag as chart version (assumed valid semver)
              VERSION="${{ github.event.release.tag_name }}"
              ;;
            *)
              # For other pushes use a 0.0.0-dev.<shortsha> pre-release
              VERSION="0.0.0-dev.${GITHUB_SHA:0:8}"
              ;;
          esac
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Set VERSION=${VERSION}"

      - name: Update Chart.yaml versions (runtime only)
        run: |
          set -euo pipefail
          echo "Updating chart versions to $VERSION"
          mkdir -p ./.chart-packages
          for chart in charts/*/Chart.yaml; do
            echo "Updating $chart"
            sed -E -i "s/^version: .*/version: \"$VERSION\"/" "$chart"
          done
          git --no-pager diff -- charts || true

      - name: Helm lint (strict)
        run: |
          helm lint charts/* --strict

      - name: Helm package (verify)
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.chart-packages"
          for d in charts/*; do
            if [ -f "$d/Chart.yaml" ]; then
              helm dependency update "$d" || true
              helm package "$d" --version "$VERSION" --destination "$GITHUB_WORKSPACE/.chart-packages"
            fi
          done

      - name: List packaged charts (debug)
        run: |
          echo "Listing $GITHUB_WORKSPACE/.chart-packages"
          ls -la "$GITHUB_WORKSPACE/.chart-packages" || true

      - name: Archive packaged charts (debug + upload-friendly)
        if: ${{ github.event_name != 'release' }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/helm-artifacts
          ARCHIVE="/tmp/helm-charts-${{ env.VERSION }}.tgz"
          echo "Creating archive $ARCHIVE"
          tar -czf "$ARCHIVE" -C "$GITHUB_WORKSPACE" ./.chart-packages || true
          ls -la "$ARCHIVE" || true

      - name: Upload packaged charts (artifact)
        if: ${{ github.event_name != 'release' }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: helm-charts-${{ env.VERSION }}
          path: /tmp/helm-charts-${{ env.VERSION }}.tgz

      - name: Publish packaged charts to GHCR (OCI)
        if: ${{ github.event_name == 'release' || github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
        env:
          CHART_PKG: ${{ github.workspace }}/.chart-packages
          OCI_REG: ${{ env.REGISTRY }}/${{ github.repository }}/helm-charts
        run: |
          set -e
          mkdir -p /tmp/oci-ctx
          export HELM_EXPERIMENTAL_OCI=1
          # Also do helm registry login (some helm versions read docker credentials; this is defensive)
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login -u "${{ github.actor }}" --password-stdin "${{ env.REGISTRY }}" || true
          for f in ${CHART_PKG}/*.tgz; do
            CHART_NAME=$(basename "$f" .tgz)
            CHART_VERSION=$(helm show chart "$f" | grep '^version:' | awk '{print $2}')
            echo "Pushing $f -> ${OCI_REG}/${CHART_NAME}:${CHART_VERSION}"
            helm push "$f" "oci://${OCI_REG}" || true
          done

      # Note: GHCR publish is handled above; GHCR_TOKEN is checked at runtime inside that step.

      - name: Publish packaged charts to Artifactory (OCI)
        if: ${{ github.event_name == 'release' || github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
        env:
          CHART_PKG: ${{ github.workspace }}/.chart-packages
          ARTIFACTORY_URL: artifactory.devops.telekom.de
          ARTIFACTORY_REPO: cit-t-caas-oci/charts/t-caas
        run: |
          set -e
          export HELM_EXPERIMENTAL_OCI=1
          echo "Logging in to Artifactory"
          echo "${{ secrets.AF_TOKEN }}" | helm registry login -u "${{ secrets.AF_USER }}" --password-stdin "${ARTIFACTORY_URL}" || true
          for f in ${CHART_PKG}/*.tgz; do
            CHART_NAME=$(basename "$f" .tgz)
            CHART_VERSION=$(helm show chart "$f" | grep '^version:' | awk '{print $2}')
            echo "Pushing $f -> ${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}/${CHART_NAME}:${CHART_VERSION}"
            helm push "$f" "oci://${ARTIFACTORY_URL}/${ARTIFACTORY_REPO}" || true
          done

      - name: Publish packaged charts to GitHub Release
        if: ${{ github.event_name == 'release' }}
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: ./.chart-packages/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
