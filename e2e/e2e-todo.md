<!--
SPDX-FileCopyrightText: 2025 Deutsche Telekom AG

SPDX-License-Identifier: Apache-2.0
-->

# End-to-end (E2E) Test Plan — Actionable Checklist

This file contains singular, implementable e2e test items grouped by functional sections. Each line is one concrete test that can be automated (scripted) and asserted in CI or locally against the `e2e/kind-setup-single.sh` environment.

Format: [ID] [Area] — Short description
- Steps: explicit step list (copy/paste into test harness)
- Expected: single explicit assertion
- Priority: High / Medium / Low

---

## Cluster & bootstrap

[C-001] Cluster: kind single-cluster creates control-plane and node
- Steps: Run `e2e/kind-setup-single.sh` up to cluster creation (stop after kind create). Verify control-plane node appears with `kubectl get nodes` and Ready status.
- Expected: One control-plane node in Ready state.
- Priority: High

[C-002] Bootstrap: API server flags mount authorization/authentication files
- Steps: After kind create, inspect the control-plane container manifest inside the node (or check `docker exec <node> cat /etc/kubernetes/manifests/kube-apiserver.yaml`) contains `--authorization-config` and `--authentication-config` paths referencing `/etc/kubernetes/authorization-config.yaml` and `/etc/kubernetes/authentication-config.yaml`.
- Expected: kube-apiserver manifest includes both flags and extraVolumes entries.
- Priority: High

## Keycloak / OIDC

[K-001] Keycloak deployment ready
- Steps: Wait for deployment label `app=keycloak` to become Ready. Use `kubectl rollout status`.
- Expected: Deployment reports successfully rolled out (1 available replica).
- Priority: High

[K-002] JWKS reachable through port-forward
- Steps: Port-forward Keycloak service and curl the JWKS URL `/realms/${KEYCLOAK_REALM}/protocol/openid-connect/certs`.
- Expected: HTTP 200 and valid JSON with `keys` array.
- Priority: High

[K-003] AuthenticationConfiguration issuer points to Keycloak
- Steps: Verify generated `$AUTHN_FILE` contains the issuer URL matching the configured `KEYCLOAK_HOST`/realm and includes the certificateAuthority block.
- Expected: `$AUTHN_FILE` contains `issuer.url` with the Keycloak host and `certificateAuthority` block.
- Priority: Medium

## Controller & webhook

[W-001] Controller deployment ready and uses local image
- Steps: After kustomize apply, set image (if needed) and verify deployment labeled `app=breakglass` is ready and that the container image matches the built `breakglass:e2e`.
- Expected: `kubectl get deploy -l app=breakglass` shows available replicas and `kubectl describe deploy` contains `Image: breakglass:e2e`.
- Priority: High

[W-002] Webhook kubeconfig points to correct in-cluster HTTP path for tenant (single-cluster only)
- Steps: Inspect `$WEBHOOK_KCFG` generated by the script; verify the `server:` entry contains `/breakglass/webhook/authorize/${TENANT_A}` (tenant-a) or configurable tenant placeholder.
- Expected: kubeconfig server URL includes `/breakglass/webhook/authorize/${TENANT_A}`.
- Priority: High

[W-003] Webhook authorizer rejects a forbidden request (deny policy)
- Steps: Create a DenyPolicy that denies `create` for `pods` for a specific subject. Use a token from a test identity and attempt to create a Pod; assert response is a denial from the webhook.
- Expected: API request receives an HTTP 429/403-like denial (webhook rejection) and event logged.
- Priority: High

## Tenants & ClusterConfig

[T-001] Create tenant secret from rewritten kubeconfig (single-cluster flow)
- Steps: Use the script's kubeconfig rewrite step to produce `MOD_KUBECONFIG`, then create a secret `tenant-a-admin` from that file and a ClusterConfig for `tenant-a`.
- Expected: Secret is created and ClusterConfig exists with `kubeconfigSecretRef` referencing the secret.
- Priority: High

[T-002] Controller reconciles tenant-scoped CRs for tenant-a and tenant-b
- Steps: For each tenant secret + ClusterConfig, create a BreakglassSession CR and wait for controller to reconcile (observe status or created subresources).
- Expected: Controller reconciles both tenant CRs independently; each CR reaches Ready or expected status.
- Priority: High

## Policy & Deny rules

[P-001] Deny access to secrets for non-admin role
- Steps: Apply a deny policy that prevents `get`/`list` on secrets for a test user. Attempt to list secrets using that user's token.
- Expected: Request is denied by webhook.
- Priority: High

[P-002] Deny creation of privileged pods
- Steps: Apply a deny policy preventing pods with hostPath or privileged= true. Try to create such a pod via API.
- Expected: Creation is blocked and error references deny policy.
- Priority: Medium

## Notifications & MailHog

[M-001] Controller sends escalation email and MailHog receives it
- Steps: Trigger an escalation that generates a notification; query MailHog API to confirm the email arrived and check subject/body contains the escalation id.
- Expected: MailHog API returns one message with expected subject and content.
- Priority: Medium

## Resilience & negative cases

[R-001] Webhook unreachable -> NoOpinion fallback permits operations during bootstrap
- Steps: Temporarily replace the webhook kubeconfig with an invalid one, attempt an operation that would normally be denied, then restore webhook and verify enforcement resumes.
- Expected: Operation allowed while webhook unreachable; enforcement resumes when webhook returns.
- Priority: Low

[R-002] Controller unhealthy rollout detection
- Steps: Set controller image to a broken variant or crashLoop, check that readiness probes fail and alerts/logs indicate deployment problems.
- Expected: Deployment shows unavailable replicas and test harness can detect failure state.
- Priority: Low

---

How to use

- Each item is intentionally singular and executable by a script. Implement tests in the language of your choice (bash, Go, Python). Each test should:
	1. Prepare preconditions (namespace, secrets, k8s objects).
	2. Execute the step list (kubectl/kustomize/curl or client libs).
	3. Assert the single `Expected` line within a short timeout.

Next steps I can implement for you

- Convert these items into a `tests/e2e/` directory with small bash or Go tests for the top priority items.
- Add a `make e2e-smoke` to run a subset (C-001, K-001, W-001, T-001) in CI.

Generated on: 2025-10-23
