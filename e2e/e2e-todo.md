# End-to-end (E2E) Test Plan — Actionable Checklist

This file contains singular, implementable e2e test items grouped by functional sections. Each line is one concrete test that can be automated (scripted) and asserted in CI or locally against the `e2e/kind-setup-single.sh` environment.

Format: [ID] [Area] — Short description
- Steps: explicit step list (copy/paste into test harness)
- Expected: single explicit assertion
- Priority: High / Medium / Low

---

## Cluster & bootstrap

[C-001] Cluster: kind single-cluster creates control-plane and node
- Steps: Run `e2e/kind-setup-single.sh` up to cluster creation (stop after kind create). Verify control-plane node appears with `kubectl get nodes` and Ready status.
- Expected: One control-plane node in Ready state.
- Priority: High

[C-002] Bootstrap: API server flags mount authorization/authentication files
- Steps: After kind create, inspect the control-plane container manifest inside the node (or check `docker exec <node> cat /etc/kubernetes/manifests/kube-apiserver.yaml`) contains `--authorization-config` and `--authentication-config` paths referencing `/etc/kubernetes/authorization-config.yaml` and `/etc/kubernetes/authentication-config.yaml`.
- Expected: kube-apiserver manifest includes both flags and extraVolumes entries.
- Priority: High

## Keycloak / OIDC

[K-001] Keycloak deployment ready
- Steps: Wait for deployment label `app=keycloak` to become Ready. Use `kubectl rollout status`.
- Expected: Deployment reports successfully rolled out (1 available replica).
- Priority: High

[K-002] JWKS reachable through port-forward
- Steps: Port-forward Keycloak service and curl the JWKS URL `/realms/${KEYCLOAK_REALM}/protocol/openid-connect/certs`.
- Expected: HTTP 200 and valid JSON with `keys` array.
- Priority: High

[K-003] AuthenticationConfiguration issuer points to Keycloak
- Steps: Verify generated `$AUTHN_FILE` contains the issuer URL matching the configured `KEYCLOAK_HOST`/realm and includes the certificateAuthority block.
- Expected: `$AUTHN_FILE` contains `issuer.url` with the Keycloak host and `certificateAuthority` block.
- Priority: Medium

## Controller & webhook

[W-001] Controller deployment ready and uses local image
- Steps: After kustomize apply, set image (if needed) and verify deployment labeled `app=breakglass` is ready and that the container image matches the built `breakglass:e2e`.
- Expected: `kubectl get deploy -l app=breakglass` shows available replicas and `kubectl describe deploy` contains `Image: breakglass:e2e`.
- Priority: High

[W-002] Webhook kubeconfig points to correct in-cluster HTTP path for tenant (single-cluster only)
- Steps: Inspect `$WEBHOOK_KCFG` generated by the script; verify the `server:` entry contains `/breakglass/webhook/authorize/${TENANT_A}` (tenant-a) or configurable tenant placeholder.
- Expected: kubeconfig server URL includes `/breakglass/webhook/authorize/${TENANT_A}`.
- Priority: High

[W-003] Webhook authorizer rejects a forbidden request (deny policy)
- Steps: Create a DenyPolicy that denies `create` for `pods` for a specific subject. Use a token from a test identity and attempt to create a Pod; assert response is a denial from the webhook.
- Expected: API request receives an HTTP 429/403-like denial (webhook rejection) and event logged.
- Priority: High

## Tenants & ClusterConfig

[T-001] Create tenant secret from rewritten kubeconfig (single-cluster flow)
- Steps: Use the script's kubeconfig rewrite step to produce `MOD_KUBECONFIG`, then create a secret `tenant-a-admin` from that file and a ClusterConfig for `tenant-a`.
- Expected: Secret is created and ClusterConfig exists with `kubeconfigSecretRef` referencing the secret.
- Priority: High

[T-002] Controller reconciles tenant-scoped CRs for tenant-a and tenant-b
- Steps: For each tenant secret + ClusterConfig, create a BreakglassSession CR and wait for controller to reconcile (observe status or created subresources).
- Expected: Controller reconciles both tenant CRs independently; each CR reaches Ready or expected status.
- Priority: High

## Policy & Deny rules

[P-001] Deny access to secrets for non-admin role
- Steps: Apply a deny policy that prevents `get`/`list` on secrets for a test user. Attempt to list secrets using that user's token.
- Expected: Request is denied by webhook.
- Priority: High

[P-002] Deny creation of privileged pods
- Steps: Apply a deny policy preventing pods with hostPath or privileged= true. Try to create such a pod via API.
- Expected: Creation is blocked and error references deny policy.
- Priority: Medium

## Pod Security Evaluation (pods/exec)

[PS-001] Exec to privileged pod blocked by risk score
- Steps: Create a DenyPolicy with PodSecurityRules (privilegedContainer=100, threshold=80). Exec into a pod with `privileged: true`.
- Expected: Request denied with "Risk score too high" message.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARDeniedByPodSecurityRiskScore

[PS-002] Exec to safe pod allowed when below threshold
- Steps: Create a DenyPolicy with PodSecurityRules (privilegedContainer=100, threshold=80). Exec into a pod with no risky features.
- Expected: Request allowed (score=0 < threshold=80).
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARAllowedForSafePod

[PS-003] Exec blocked by blockFactors (hostNetwork)
- Steps: Create a DenyPolicy with `blockFactors: ["hostNetwork"]`. Exec into a pod with `hostNetwork: true`.
- Expected: Request denied regardless of risk score.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARDeniedByBlockFactor

[PS-004] Exec to exempted namespace allowed
- Steps: Create a DenyPolicy with `exemptions.namespaces: ["kube-system"]`. Exec into a privileged pod in kube-system.
- Expected: Request allowed (namespace is exempt).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARAllowedByPodSecurityExemption

[PS-005] Exec denied when pod not found (failMode=closed)
- Steps: Create a DenyPolicy with `failMode: closed`. Exec into a pod that doesn't exist.
- Expected: Request denied (fail-closed behavior).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodSecurityFailModeClosed

[PS-006] Exec allowed when pod not found (failMode=open)
- Steps: Create a DenyPolicy with `failMode: open`. Exec into a pod that doesn't exist.
- Expected: Request allowed (fail-open behavior).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodSecurityFailModeOpen

[PS-007] Attach to privileged pod blocked
- Steps: Create a DenyPolicy with PodSecurityRules. Attach to a privileged pod.
- Expected: Request denied (attach triggers same evaluation as exec).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodsAttachEvaluated

[PS-008] Portforward to hostPID pod blocked
- Steps: Create a DenyPolicy with `blockFactors: ["hostPID"]`. Portforward to a pod with `hostPID: true`.
- Expected: Request denied (portforward triggers security evaluation).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodsPortforwardEvaluated

[PS-009] Policy applies only to specified subresources
- Steps: Create a DenyPolicy with `appliesTo.subresources: ["exec"]`. Exec should be blocked, attach should be allowed.
- Expected: Exec denied, attach allowed (scoped to exec only).
- Priority: Low
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodSecurityScopeSubresource

[PS-010] Escalation override raises risk threshold
- Steps: Create BreakglassEscalation with `podSecurityOverrides.maxAllowedScore: 200`. Exec into privileged pod (score=100).
- Expected: Request allowed (override raises threshold from 50 to 200).
- Priority: Low
- Implemented: Skipped (webhook doesn't wire PodSecurityOverrides to Action yet)

[PS-011] Capability scoring blocks SYS_ADMIN containers
- Steps: Create DenyPolicy with `capabilities: {SYS_ADMIN: 100}` and threshold 80. Exec into pod with SYS_ADMIN capability.
- Expected: Request denied due to capability risk score.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodSecurityCapabilities

[PS-012] Label-based exemption allows privileged pods with exempt label
- Steps: Create DenyPolicy with `exemptions.podLabels: {"breakglass.telekom.com/security-exempt": "true"}`. Exec into labeled privileged pod.
- Expected: Request allowed (label exemption).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodSecurityLabelExemption

[PS-013] Cumulative risk score from multiple factors
- Steps: Create DenyPolicy with multiple risk factors (hostNetwork=30, hostPID=30, runAsRoot=30, threshold=60). Test pods with 1, 2, 3 factors.
- Expected: 1 factor allowed, 2 factors warned, 3 factors denied.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARPodSecurityCumulativeScore

## Resource Operations (SAR)

[RO-001] List pods in namespace allowed with approved session
- Steps: Create and approve session. Invoke SAR for `list pods` in default namespace.
- Expected: Request allowed.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARResourceOperations

[RO-002] Get deployment allowed with approved session
- Steps: Create and approve session. Invoke SAR for `get deployments` in apps group.
- Expected: Request allowed.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARResourceOperations

[RO-003] Delete pod allowed with approved session
- Steps: Create and approve session. Invoke SAR for `delete pods`.
- Expected: Request allowed.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARResourceOperations

[RO-004] List secrets blocked by deny policy
- Steps: Create deny policy blocking `get`/`list` on secrets. Invoke SAR for `list secrets`.
- Expected: Request denied by policy.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARResourceOperations

[RO-005] Delete namespace blocked by deny policy
- Steps: Create deny policy blocking `delete` on namespaces. Invoke SAR for `delete namespace`.
- Expected: Request denied by policy.
- Priority: High
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARResourceOperations

## Subresource Operations

[SR-001] Get deployment status allowed
- Steps: Create and approve session. Invoke SAR for `get deployments/status`.
- Expected: Request allowed.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARSubresources

[SR-002] Get pod logs allowed
- Steps: Create and approve session. Invoke SAR for `get pods/log`.
- Expected: Request allowed.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARSubresources

[SR-003] Pod exec blocked by rule-based deny policy
- Steps: Create deny policy with rule blocking `create pods/exec`. Invoke SAR for pods/exec.
- Expected: Request denied by rule (not pod security).
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARSubresources

[SR-004] Scale deployment allowed
- Steps: Create and approve session. Invoke SAR for `update deployments/scale`.
- Expected: Request allowed.
- Priority: Low
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARSubresources

## Wildcard and Pattern Matching

[WP-001] Wildcard deny policy blocks all operations in namespace
- Steps: Create deny policy with `verbs: ["*"], resources: ["*"], namespaces: ["kube-system"]`. Test access to kube-system vs default.
- Expected: kube-system denied, default allowed.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARWildcardDenyPolicy

[WP-002] ResourceNames pattern blocks specific secrets
- Steps: Create deny policy with `resourceNames: ["database-password", "api-key"]`. Test access to blocked vs non-blocked secrets.
- Expected: Blocked secrets denied, other secrets allowed.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARResourceNamePatterns

## Policy Precedence

[PP-001] Multiple policies evaluated by precedence
- Steps: Create two deny policies with different precedence (10 and 100) blocking different verbs. Test both verbs.
- Expected: Both policies enforce, lower precedence evaluated first.
- Priority: Medium
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARMultiplePoliciesPrecedence

## Custom Resources

[CR-001] List breakglass sessions allowed
- Steps: Create and approve session. Invoke SAR for `list breakglasssessions` in breakglass.t-caas.telekom.com group.
- Expected: Request allowed.
- Priority: Low
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARCRDOperations

[CR-002] Get deny policy allowed
- Steps: Create and approve session. Invoke SAR for `get denypolicies`.
- Expected: Request allowed.
- Priority: Low
- Implemented: pkg/api/api_end_to_end_test.go:TestEndToEndSARCRDOperations

## Notifications & MailHog

[M-001] Controller sends escalation email and MailHog receives it
- Steps: Trigger an escalation that generates a notification; query MailHog API to confirm the email arrived and check subject/body contains the escalation id.
- Expected: MailHog API returns one message with expected subject and content.
- Priority: Medium

## Resilience & negative cases

[R-001] Webhook unreachable -> NoOpinion fallback permits operations during bootstrap
- Steps: Temporarily replace the webhook kubeconfig with an invalid one, attempt an operation that would normally be denied, then restore webhook and verify enforcement resumes.
- Expected: Operation allowed while webhook unreachable; enforcement resumes when webhook returns.
- Priority: Low

[R-002] Controller unhealthy rollout detection
- Steps: Set controller image to a broken variant or crashLoop, check that readiness probes fail and alerts/logs indicate deployment problems.
- Expected: Deployment shows unavailable replicas and test harness can detect failure state.
- Priority: Low

---

## Debug Sessions

[D-001] DebugPodTemplate creation and validation
- Steps: Apply a DebugPodTemplate CR with a valid pod spec. Verify the resource is created successfully.
- Expected: `kubectl get debugpodtemplates` shows the template with correct displayName.
- Priority: High

[D-002] DebugSessionTemplate creation with pod template reference
- Steps: Apply a DebugSessionTemplate CR that references an existing DebugPodTemplate. Verify the resource is created successfully.
- Expected: `kubectl get debugsessiontemplates` shows the template with mode=workload.
- Priority: High

[D-003] DebugSession creation via API
- Steps: Create a DebugSession CR via the REST API POST endpoint. Verify the session is created and enters Pending state.
- Expected: DebugSession CR exists with status.state=Pending or PendingApproval.
- Priority: High

[D-004] DebugSession auto-approval for allowed clusters
- Steps: Create a DebugSessionTemplate with autoApproveFor.clusters matching the test cluster. Create a DebugSession. Verify auto-approval.
- Expected: DebugSession transitions to Active state without manual approval.
- Priority: High

[D-005] DebugSession manual approval workflow
- Steps: Create a DebugSessionTemplate without autoApproveFor. Create a DebugSession. Approve via API.
- Expected: DebugSession transitions from PendingApproval to Active after approval.
- Priority: High

[D-006] DebugSession rejection workflow
- Steps: Create a DebugSession requiring approval. Reject via API with reason.
- Expected: DebugSession transitions to Failed state with rejection reason in status.
- Priority: Medium

[D-007] DebugSession workload deployment
- Steps: Create an Active DebugSession with mode=workload. Verify DaemonSet/Deployment is created on target cluster.
- Expected: status.deployedResources lists the created workload. Pods are running in target namespace.
- Priority: High

[D-008] DebugSession participant join
- Steps: Create an Active DebugSession. Use API to join as another user.
- Expected: status.participants includes both owner and joined participant.
- Priority: Medium

[D-009] DebugSession renewal
- Steps: Create an Active DebugSession. Use API to renew the session.
- Expected: status.expiresAt is extended. status.renewalCount is incremented.
- Priority: Medium

[D-010] DebugSession termination
- Steps: Create an Active DebugSession. Use API to terminate.
- Expected: DebugSession transitions to Terminated state. Deployed resources are cleaned up.
- Priority: High

[D-011] DebugSession expiration
- Steps: Create a DebugSession with very short duration (e.g., 1m). Wait for expiration.
- Expected: DebugSession transitions to Expired state. Deployed resources are cleaned up.
- Priority: Medium

[D-012] DebugSession kubectl-debug mode (ephemeral containers)
- Steps: Create a DebugSessionTemplate with mode=kubectl-debug and ephemeralContainers.enabled=true. Create a DebugSession. Verify webhook allows ephemeral container injection.
- Expected: Session is active and kubectl debug commands are permitted.
- Priority: Medium

[D-013] DebugSession constraints enforcement
- Steps: Create a DebugSessionTemplate with maxDuration=1h. Try to create a DebugSession requesting 4h.
- Expected: Session is created with duration capped at maxDuration (1h).
- Priority: Medium

[D-014] DebugSession access control - allowed groups
- Steps: Create a DebugSessionTemplate with allowed.groups=[sre-team]. Try to create session as user not in sre-team.
- Expected: Session creation is rejected with authorization error.
- Priority: High

[D-015] DebugSession cleanup after termination
- Steps: Create and terminate a DebugSession. Verify all deployed resources are removed.
- Expected: No orphaned DaemonSets/Deployments in target namespace from the session.
- Priority: High

---

How to use

- Each item is intentionally singular and executable by a script. Implement tests in the language of your choice (bash, Go, Python). Each test should:
	1. Prepare preconditions (namespace, secrets, k8s objects).
	2. Execute the step list (kubectl/kustomize/curl or client libs).
	3. Assert the single `Expected` line within a short timeout.

Next steps I can implement for you

- Convert these items into a `tests/e2e/` directory with small bash or Go tests for the top priority items.
- Add a `make e2e-smoke` to run a subset (C-001, K-001, W-001, T-001) in CI.

Generated on: 2025-10-23
Updated on: 2025-01-xx (Added Debug Sessions section)
