{{- $root := .Values -}}
{{- range $i, $esc := .Values.escalations }}
apiVersion: breakglass.t-caas.telekom.com/v1alpha1
kind: BreakglassEscalation
metadata:
  name: {{ default (printf "escalation-%d" $i) $esc.name | trunc 63 | trimSuffix "-" }}
  namespace: {{ $.Release.Namespace }}
spec:
  allowed:
    clusters:
{{ toYaml $esc.allowed.clusters | indent 6 }}
    groups:
{{ toYaml $esc.allowed.groups | indent 6 }}
  escalatedGroup: {{ $esc.escalatedGroup }}
  approvers:
    groups:
{{ toYaml $esc.approvers.groups | indent 6 }}
    {{- if $esc.approvers.hiddenFromUI }}
    hiddenFromUI:
{{ toYaml $esc.approvers.hiddenFromUI | indent 6 }}
    {{- end }}
  # Optional: restrict approver email domains for this escalation
  {{- if $esc.allowedApproverDomains }}
  allowedApproverDomains:
{{ toYaml $esc.allowedApproverDomains | indent 4 }}
  {{- end }}
  # Optional: block self-approval for this escalation (true/false)
  {{- if hasKey $esc "blockSelfApproval" }}
  blockSelfApproval: {{ $esc.blockSelfApproval }}
  {{- end }}
  # Optional: disable notifications for this escalation (true/false)
  {{- if hasKey $esc "disableNotifications" }}
  disableNotifications: {{ $esc.disableNotifications }}
  {{- end }}
  # Optional: exclude specific users/groups from notifications
  {{- if $esc.notificationExclusions }}
  notificationExclusions:
    {{- if $esc.notificationExclusions.users }}
    users:
{{ toYaml $esc.notificationExclusions.users | indent 6 }}
    {{- end }}
    {{- if $esc.notificationExclusions.groups }}
    groups:
{{ toYaml $esc.notificationExclusions.groups | indent 6 }}
    {{- end }}
  {{- end }}
  {{- if $esc.requestReason }}
  requestReason:
    mandatory: {{ default false $esc.requestReason.mandatory }}
    description: {{ quote (default "" $esc.requestReason.description) }}
  {{- end }}
  maxValidFor: {{ $esc.maxValidFor | default "1h" }}
  retainFor: {{ $esc.retainFor | default "24h" }}
  idleTimeout: {{ $esc.idleTimeout | default "1h" }}
---
{{- end }}
