# Adds namespace to all resources.
namespace: breakglass-system

# Value of this field is prepended to the
# names of all resources, e.g. a deployment named
# "wordpress" becomes "alices-wordpress".
# Note that it should also match with the prefix (text before '-') of the namespace
# field above.
namePrefix: breakglass-

# Labels to add to all resources and selectors.
#labels:
#- includeSelectors: true
#  pairs:
#    someName: someValue

resources:
- ../crd
- ../rbac
- ../deployment
- ../webhook
- ./resources/keycloak.yaml
- ./resources/mailhog.yaml
- ./resources/kafka.yaml
- ./resources/audit-webhook-receiver.yaml
# NOTE: CRs requiring webhook validation are applied separately by e2e/kind-setup-single.sh
# AFTER the webhook CA bundle is patched and controller is ready.
# See: kind-setup-single.sh apply_e2e_test_crs() function
# - ./resources/crs/audit-config-test.yaml
# - ./resources/crs/cluster-configs-test.yaml
# - ./resources/crs/debug-templates-test.yaml
# - ./resources/crs/deny-policies-test.yaml
# - ./resources/crs/escalations-test.yaml
# - ./resources/idp.yaml
- ./resources/rbac/rbac-hub-test.yaml
- ./resources/rbac/tenant-rbac-test.yaml

images:
 - name: breakglass
   newName: breakglass
   newTag: e2e

patches:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: manager
  path: ./resources/keycloak_wait_initcontainer.yaml
# [CERT-CONTROLLER] this target should be commented if automated webhook certificate generation is to be used
- target:
    group: apps
    version: v1
    kind: Deployment
    name: manager
  path: ./resources/cert_volumes_patch.yaml

# JSON patches for deployment modifications
- target:
    group: apps
    version: v1
    kind: Deployment
    name: manager
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: breakglass:e2e
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: IfNotPresent
    # Override check interval for faster e2e testing (default is 10m)
    - op: replace
      path: /spec/template/spec/containers/0/args/6
      value: --cluster-config-check-interval=10s
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --debug
    # Webhook configuration
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --enable-validating-webhooks=true
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --webhook-cert-path=/tmp/k8s-webhook-server/serving-certs
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --webhook-bind-address=0.0.0.0:9443
    - op: add
      path: /spec/template/spec/containers/0/ports/-
      value:
        name: webhook
        containerPort: 9443
        protocol: TCP
    # Mount webhook serving certs
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts/-
      value:
        mountPath: /tmp/k8s-webhook-server/serving-certs
        name: webhook-certs
        readOnly: true
    - op: add
      path: /spec/template/spec/volumes/-
      value:
        name: webhook-certs
        secret:
          defaultMode: 420
          secretName: webhook-server-cert
    # Set faster cleanup interval for E2E tests (10 seconds instead of 5 minutes)
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: CLEANUP_INTERVAL
        value: "10s"
    # Increase memory limits for E2E tests (controller handles many CRs)
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "1Gi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "512Mi"
# Increase Kafka resources to prevent OOM/crashes in CI
- target:
    group: apps
    version: v1
    kind: Deployment
    name: kafka
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "2Gi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "1Gi"
# [CERT-CONTROLLER] this target should be enabled if automated webhook certificate generation is to be used 
# - target:
#     group: apps
#     version: v1
#     kind: Deployment
#     name: manager
#   patch: |- 
#     - op: add
#       path: /spec/template/spec/containers/0/args/-
#       value: --webhook-cert-generation=true
#     - op: add
#       path: /spec/template/spec/containers/0/args/-
#       value: --webhook-service-name=breakglass-webhook-service



  #     - op: add
  #       path: /spec/template/spec/containers/0/args/-
  #       value: --webhook-validating-config-name=breakglass-validating-webhook-configuration
  #     - op: add
  #       path: /spec/template/spec/containers/0/args/-
  #       value: --breakglass-namespace=$(POD_NAMESPACE)
  #     - op: add
  #       path: /spec/template/spec/containers/0/args/-
  #       value: --webhooks-metrics-secure=true
  #     - op: add
  #       path: /spec/template/spec/containers/0/volumeMounts/-
  #       value:
  #         mountPath: /tmp/k8s-webhook-server/serving-certs
  #         name: webhook-cert
  #         readOnly: true
  #     - op: add
  #       path: /spec/template/spec/volumes/-
  #       value:
  #         name: webhook-cert
  #         secret:
  #           defaultMode: 420
  #           secretName: breakglass-webhook-service

configMapGenerator:
- name: config
  files:
  - ./config.yaml
- name: keycloak-realm
  files:
  - breakglass-e2e.json=./resources/breakglass-e2e-realm.json
- name: breakglass-certs
  files:
  - certs/kind-setup-single-tls/ca.crt


secretGenerator:
- name: keycloak-tls
  files:
  - tls.crt=certs/kind-setup-single-tls/server.crt
  - tls.key=certs/kind-setup-single-tls/server.key
  type: "kubernetes.io/tls"
# Secret for Keycloak group sync service account (enables group-based approver notifications)
- name: breakglass-group-sync-secret
  literals:
  - client-secret=breakglass-group-sync-secret
  type: "Opaque"

        
# [CERTMANAGER] To enable cert-manager, uncomment all sections with 'CERTMANAGER' prefix.
# Uncomment the following replacements to add the cert-manager CA injection annotations
#replacements:
# - source: # Uncomment the following block if you have a ValidatingWebhook (--programmatic-validation)
#     kind: Certificate
#     group: cert-manager.io
#     version: v1
#     name: serving-cert # This name should match the one in certificate.yaml
#     fieldPath: .metadata.namespace # Namespace of the certificate CR
#   targets:
#     - select:
#         kind: ValidatingWebhookConfiguration
#       fieldPaths:
#         - .metadata.annotations.[cert-manager.io/inject-ca-from]
#       options:
#         delimiter: '/'
#         index: 0
#         create: true
# - source:
#     kind: Certificate
#     group: cert-manager.io
#     version: v1
#     name: serving-cert # This name should match the one in certificate.yaml
#     fieldPath: .metadata.name
#   targets:
#     - select:
#         kind: ValidatingWebhookConfiguration
#       fieldPaths:
#         - .metadata.annotations.[cert-manager.io/inject-ca-from]
#       options:
#         delimiter: '/'
#         index: 1
#         create: true
#
# - source: # Uncomment the following block if you have a DefaultingWebhook (--defaulting )
#     kind: Certificate
#     group: cert-manager.io
#     version: v1
#     name: serving-cert # This name should match the one in certificate.yaml
#     fieldPath: .metadata.namespace # Namespace of the certificate CR
#   targets:
#     - select:
#         kind: MutatingWebhookConfiguration
#       fieldPaths:
#         - .metadata.annotations.[cert-manager.io/inject-ca-from]
#       options:
#         delimiter: '/'
#         index: 0
#         create: true
# - source:
#     kind: Certificate
#     group: cert-manager.io
#     version: v1
#     name: serving-cert # This name should match the one in certificate.yaml
#     fieldPath: .metadata.name
#   targets:
#     - select:
#         kind: MutatingWebhookConfiguration
#       fieldPaths:
#         - .metadata.annotations.[cert-manager.io/inject-ca-from]
#       options:
#         delimiter: '/'
#         index: 1
#         create: true
#
# - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
#     kind: Certificate
#     group: cert-manager.io
#     version: v1
#     name: serving-cert # This name should match the one in certificate.yaml
#     fieldPath: .metadata.namespace # Namespace of the certificate CR
#   targets:
#     - select:
#         kind: CustomResourceDefinition
#       fieldPaths:
#         - .metadata.annotations.[cert-manager.io/inject-ca-from]
#       options:
#         delimiter: '/'
#         index: 0
#         create: true
# - source:
#     kind: Certificate
#     group: cert-manager.io
#     version: v1
#     name: serving-cert # This name should match the one in certificate.yaml
#     fieldPath: .metadata.name
#   targets:
#     - select:
#         kind: CustomResourceDefinition
#       fieldPaths:
#         - .metadata.annotations.[cert-manager.io/inject-ca-from]
#       options:
#         delimiter: '/'
#         index: 1
#         create: true
#
# - source: # Uncomment the following block if you enable cert-manager
#     kind: Service
#     version: v1
#     name: webhook-service
#     fieldPath: .metadata.name # Name of the service
#   targets:
#     - select:
#         kind: Certificate
#         group: cert-manager.io
#         version: v1
#       fieldPaths:
#         - .spec.dnsNames.0
#         - .spec.dnsNames.1
#       options:
#         delimiter: '.'
#         index: 0
#         create: true
# - source:
#     kind: Service
#     version: v1
#     name: webhook-service
#     fieldPath: .metadata.namespace # Namespace of the service
#   targets:
#     - select:
#         kind: Certificate
#         group: cert-manager.io
#         version: v1
#       fieldPaths:
#         - .spec.dnsNames.0
#         - .spec.dnsNames.1
#       options:
#         delimiter: '.'
#         index: 1
#         create: true
