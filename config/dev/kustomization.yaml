apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Ensure all resources (including generated ones) get the correct namespace
namespace: breakglass-system

# Build on top of the base kustomization (includes crd, rbac, deployment, webhook)
resources:
- ../base
# Dev-specific resources
- ./resources/keycloak.yaml
- ./resources/mailhog.yaml
- ./resources/kafka.yaml
- ./resources/audit-webhook-receiver.yaml
# NOTE: CRs requiring webhook validation are applied separately by e2e/kind-setup-single.sh
# AFTER the webhook CA bundle is patched and controller is ready.
# See: kind-setup-single.sh apply_e2e_test_crs() function
# - ./resources/crs/audit-config-test.yaml
# - ./resources/crs/cluster-configs-test.yaml
# - ./resources/crs/debug-templates-test.yaml
# - ./resources/crs/deny-policies-test.yaml
# - ./resources/crs/escalations-test.yaml
# - ./resources/idp.yaml
- ./resources/rbac/rbac-hub-test.yaml
- ./resources/rbac/tenant-rbac-test.yaml

images:
 - name: breakglass
   newName: breakglass
   newTag: e2e

patches:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: manager
  path: ./resources/keycloak_wait_initcontainer.yaml
# [CERT-CONTROLLER] this target should be commented if automated webhook certificate generation is to be used
- target:
    group: apps
    version: v1
    kind: Deployment
    name: manager
  path: ./resources/cert_volumes_patch.yaml

# JSON patches for dev-specific deployment modifications
# NOTE: Webhook configuration comes from ../base, only dev-specific patches here
- target:
    group: apps
    version: v1
    kind: Deployment
    name: manager
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: breakglass:e2e
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: IfNotPresent
    # Override check interval for faster e2e testing (default is 10m)
    - op: replace
      path: /spec/template/spec/containers/0/args/6
      value: --cluster-config-check-interval=10s
    - op: add
      path: /spec/template/spec/containers/0/args/-
      value: --debug
    # Set faster cleanup interval for E2E tests (10 seconds instead of 5 minutes)
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: CLEANUP_INTERVAL
        value: "10s"
    # Increase memory limits for E2E tests (controller handles many CRs)
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "1Gi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "512Mi"
# Increase Kafka resources to prevent OOM/crashes in CI
- target:
    group: apps
    version: v1
    kind: Deployment
    name: kafka
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "2Gi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "1Gi"

configMapGenerator:
- name: config
  behavior: replace
  files:
  - ./config.yaml
  options:
    disableNameSuffixHash: true
- name: keycloak-realm
  files:
  - breakglass-e2e.json=./resources/breakglass-e2e-realm.json
  options:
    disableNameSuffixHash: true
- name: breakglass-certs
  files:
  - certs/kind-setup-single-tls/ca.crt
  options:
    disableNameSuffixHash: true

secretGenerator:
- name: keycloak-tls
  files:
  - tls.crt=certs/kind-setup-single-tls/server.crt
  - tls.key=certs/kind-setup-single-tls/server.key
  type: "kubernetes.io/tls"
  options:
    disableNameSuffixHash: true
# Secret for Keycloak group sync service account (enables group-based approver notifications)
- name: breakglass-group-sync-secret
  literals:
  - client-secret=breakglass-group-sync-secret
  type: "Opaque"
