---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: identityproviders.breakglass.t-caas.telekom.com
spec:
  group: breakglass.t-caas.telekom.com
  names:
    kind: IdentityProvider
    listKind: IdentityProviderList
    plural: identityproviders
    singular: identityprovider
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.issuer
      name: Issuer
      type: string
    - jsonPath: .spec.groupSyncProvider
      name: GroupSync
      type: string
    - jsonPath: .status.conditions[?(@.type=="Ready")].status
      name: Ready
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: |-
          IdentityProvider represents a configured identity provider with OIDC authentication and optional group synchronization
          IdentityProvider is cluster-scoped, allowing global identity provider configuration.
          All identity providers use OIDC for user authentication. Group synchronization can be optionally
          configured using providers like Keycloak. Multiple IdentityProviders can be configured per cluster.
          The Issuer field must be set to the OIDC issuer URL (matching the 'iss' claim in JWT tokens) to enable
          multi-IDP support. ClusterConfig and BreakglassEscalation can restrict access to specific IDPs by name.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: IdentityProviderSpec defines the desired state of an IdentityProvider
            properties:
              disabled:
                description: Disabled can be set to true to temporarily disable this
                  provider without deleting it
                type: boolean
              displayName:
                description: DisplayName is a human-readable name for this provider
                  (shown in UI/logs)
                maxLength: 100
                type: string
              groupSyncProvider:
                description: |-
                  GroupSyncProvider specifies which provider to use for group synchronization (optional)
                  If not set, group synchronization is disabled
                enum:
                - Keycloak
                type: string
              issuer:
                description: |-
                  Issuer is the OIDC issuer URL, which must match the 'iss' claim in JWT tokens
                  This uniquely identifies the identity provider and is used to determine which provider
                  authenticated a user based on their JWT token.
                  Example: https://auth.example.com
                maxLength: 253
                pattern: ^https://.+
                type: string
              keycloak:
                description: |-
                  Keycloak holds Keycloak-specific configuration for group synchronization
                  Required when groupSyncProvider is "Keycloak"
                properties:
                  baseURL:
                    description: |-
                      BaseURL is the Keycloak server URL
                      Example: https://keycloak.example.com
                    maxLength: 253
                    minLength: 1
                    pattern: ^https://.+
                    type: string
                  cacheTTL:
                    description: 'CacheTTL is the duration to cache user/group memberships
                      (default: 10m)'
                    pattern: ^([0-9]+(ns|us|µs|ms|s|m|h))+$
                    type: string
                  certificateAuthority:
                    description: CertificateAuthority contains a PEM encoded CA certificate
                      for TLS validation
                    type: string
                  clientID:
                    description: ClientID is the service account client ID for group/user
                      queries (should have view-users/view-groups only)
                    maxLength: 253
                    minLength: 1
                    pattern: ^\S+$
                    type: string
                  clientSecretRef:
                    description: ClientSecretRef references a Secret containing the
                      client secret
                    properties:
                      key:
                        description: Key is the data key in the secret (defaults to
                          "value" if not specified)
                        type: string
                      name:
                        description: Name is the name of the secret
                        minLength: 1
                        type: string
                      namespace:
                        description: Namespace is the namespace containing the secret
                          (supports cross-namespace references)
                        minLength: 1
                        type: string
                    required:
                    - name
                    - namespace
                    type: object
                  insecureSkipVerify:
                    description: InsecureSkipVerify allows skipping TLS verification
                      (NOT for production!)
                    type: boolean
                  realm:
                    description: Realm is the Keycloak realm name
                    maxLength: 253
                    minLength: 1
                    type: string
                  requestTimeout:
                    description: 'RequestTimeout is the timeout for Keycloak API requests
                      (default: 10s)'
                    pattern: ^([0-9]+(ns|us|µs|ms|s|m|h))+$
                    type: string
                required:
                - baseURL
                - clientID
                - clientSecretRef
                - realm
                type: object
              oidc:
                description: |-
                  OIDC holds mandatory OIDC configuration for user authentication
                  This is the base authentication mechanism for all identity providers
                properties:
                  authority:
                    description: |-
                      Authority is the OIDC provider authority endpoint
                      Example: https://auth.example.com
                    maxLength: 253
                    minLength: 1
                    pattern: ^https://.+
                    type: string
                  certificateAuthority:
                    description: CertificateAuthority contains a PEM encoded CA certificate
                      for TLS validation
                    type: string
                  clientID:
                    description: ClientID is the OIDC client ID for user authentication
                      (frontend/UI)
                    maxLength: 253
                    minLength: 1
                    pattern: ^\S+$
                    type: string
                  insecureSkipVerify:
                    description: InsecureSkipVerify allows skipping TLS verification
                      (NOT for production!)
                    type: boolean
                  jwksEndpoint:
                    description: |-
                      JWKSEndpoint is the endpoint for fetching JSON Web Key Sets
                      If empty, defaults to Authority/.well-known/openid-configuration
                    maxLength: 253
                    pattern: ^https://.+
                    type: string
                required:
                - authority
                - clientID
                type: object
              primary:
                description: |-
                  Primary indicates if this is the primary identity provider (used by default)
                  Deprecated: Primary is kept for backward compatibility. In multi-IDP mode, use ClusterConfig.IdentityProviderRefs instead.
                type: boolean
            required:
            - oidc
            type: object
          status:
            description: IdentityProviderStatus defines the observed state of an IdentityProvider
            properties:
              conditions:
                description: |-
                  Conditions represent the latest available observations of the IdentityProvider's state.
                  All status information is conveyed through conditions:
                  - Ready: Configuration is valid and provider is operational
                  - ConversionFailed: Configuration conversion failed
                  - ValidationFailed: Configuration validation failed
                  - GroupSyncHealthy: Group sync provider is healthy and reachable
                  - CacheUpdated: Provider cache has been successfully updated
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              observedGeneration:
                description: ObservedGeneration reflects the generation of the most
                  recently observed IdentityProvider
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
