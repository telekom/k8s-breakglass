# Example IdentityProvider configuration with Keycloak for group synchronization
# This configuration uses OIDC for user authentication and Keycloak for group/user sync
#
# Key components:
# 1. OIDC Configuration: Used by the frontend for user authentication
# 2. Keycloak Group Sync: Used by the backend to fetch group memberships
# 3. Issuer: The OIDC issuer URL (typically Keycloak realm URL) that matches the 'iss' claim in JWT tokens
#
# The Keycloak admin client should have view-users and view-groups permissions only
apiVersion: breakglass.t-caas.telekom.com/v1alpha1
kind: IdentityProvider
metadata:
  name: primary-keycloak
spec:
  # Mandatory OIDC configuration for user authentication
  # This is how the frontend authenticates users
  oidc:
    # Authority is typically the Keycloak server base URL
    authority: "https://auth.example.com"
    clientID: "breakglass-ui"
    
    # Optional: jwksEndpoint for custom JWKS endpoint
    # If not specified, defaults to Authority/.well-known/openid-configuration
    # jwksEndpoint: "https://auth.example.com/.well-known/jwks.json"

    # Optional: CA certificate for TLS validation
    # certificateAuthority: |
    #   -----BEGIN CERTIFICATE-----
    #   MIIDXTCCAkWgAwIBAgIJAJXuYv...
    #   -----END CERTIFICATE-----

  # Issuer is the OIDC issuer URL that must match the 'iss' claim in JWT tokens
  # For Keycloak, this is typically: https://keycloak.example.com/realms/master
  # This field is MANDATORY in multi-IDP mode and used by the SAR webhook
  # to identify which provider authenticated a user
  issuer: "https://auth.example.com/realms/master"

  # Enable Keycloak for group synchronization
  # This allows the backend to fetch user group memberships from Keycloak
  groupSyncProvider: Keycloak

  # Keycloak configuration for group/user queries
  # This is used by the backend reconciler to sync group information
  keycloak:
    # BaseURL is the Keycloak server URL
    baseURL: "https://auth.example.com"

    # Realm is the Keycloak realm name where users and groups are stored
    realm: "master"

    # ClientID is the service account client for group/user API queries
    # This client should ONLY have view-users and view-groups permissions
    # IMPORTANT: This is different from the OIDC clientID above
    clientID: "breakglass-admin"

    # ClientSecretRef references a Secret containing the admin client secret
    # The secret should be created in the same namespace as the IdentityProvider CR
    # Create with: kubectl create secret generic keycloak-secret \
    #   --from-literal=clientSecret='your-client-secret'
    clientSecretRef:
      name: keycloak-secret
      key: clientSecret
      namespace: default

    # CacheTTL is the duration to cache user/group memberships
    # Recommended: 5m to 30m depending on how frequently group memberships change
    # Higher values improve performance but delay visibility of group changes
    cacheTTL: "10m"

    # RequestTimeout is the timeout for individual Keycloak API requests
    # Default: 10s. Increase if you experience timeout errors with slow Keycloak instances
    requestTimeout: "10s"

    # InsecureSkipVerify allows skipping TLS certificate verification
    # WARNING: Only use in development/testing environments!
    # insecureSkipVerify: false

    # CertificateAuthority (optional) contains a PEM-encoded CA certificate
    # for validating the TLS certificate presented by the Keycloak server
    # certificateAuthority: |
    #   -----BEGIN CERTIFICATE-----
    #   MIIDXTCCAkWgAwIBAgIJAJXuYv...
    #   -----END CERTIFICATE-----

  # This is the primary/default identity provider
  primary: true
  displayName: "Primary Keycloak Provider"

---
# Secret containing Keycloak admin client credentials
# IMPORTANT: Create this secret BEFORE applying the IdentityProvider CR
# Otherwise the reconciler will fail trying to fetch the secret
#
# Option 1: Using kubectl create
# kubectl create secret generic keycloak-secret \
#   --from-literal=clientSecret='your-keycloak-admin-secret'
#
# Option 2: Create the secret manually with this YAML
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-secret
type: Opaque
stringData:
  # The client secret for the Keycloak admin service account
  # This is used to authenticate API requests to Keycloak for group/user queries
  # Ensure this client has ONLY view-users and view-groups roles
  clientSecret: "your-keycloak-admin-client-secret-here"

---
# Example: Secondary OIDC provider (enables multi-IDP mode)
# In multi-IDP setups, users see an IDP selector when 2+ enabled providers exist
apiVersion: breakglass.t-caas.telekom.com/v1alpha1
kind: IdentityProvider
metadata:
  name: secondary-oidc
spec:
  # Different OIDC provider (no group sync)
  oidc:
    authority: "https://backup-auth.example.com"
    clientID: "breakglass-ui-fallback"

  # IMPORTANT: Different issuer URL to distinguish this provider
  issuer: "https://backup-auth.example.com"

  # Not the default provider, but available for users to choose
  primary: false
  displayName: "Backup OIDC Provider"
