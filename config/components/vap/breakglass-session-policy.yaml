# SPDX-FileCopyrightText: 2025 Deutsche Telekom AG
#
# SPDX-License-Identifier: Apache-2.0

# ValidatingAdmissionPolicy: BreakglassSession validations
#
# Supplements webhook-based validation with in-process CEL checks that
# run inside the API server (no webhook latency, higher availability).
#
# Phase 1 — deployed in Warn mode alongside existing webhooks.
# Validations reflect rules already enforced by the webhook; deploying
# as VAP provides defense-in-depth and paves the way for future webhook
# removal.
#
# Requires Kubernetes 1.30+ (ValidatingAdmissionPolicy GA).

apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: breakglass-session-validation
  labels:
    app.kubernetes.io/name: breakglass
    app.kubernetes.io/component: admission
    breakglass.t-caas.telekom.com/phase: "1"
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["breakglass.t-caas.telekom.com"]
        apiVersions: ["v1alpha1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["breakglasssessions"]

  validations:
    # --- CREATE-only validations (skip on UPDATE via has(oldSelf)) ---

    # Cluster must be non-empty
    - expression: >-
        has(oldSelf) || object.spec.cluster.size() > 0
      message: "spec.cluster is required"
      reason: Invalid

    # User must be non-empty
    - expression: >-
        has(oldSelf) || object.spec.user.size() > 0
      message: "spec.user is required"
      reason: Invalid

    # GrantedGroup must be non-empty
    - expression: >-
        has(oldSelf) || object.spec.grantedGroup.size() > 0
      message: "spec.grantedGroup is required"
      reason: Invalid

    # Reason must be at least 10 characters
    - expression: >-
        has(oldSelf) || object.spec.reason.size() >= 10
      message: "spec.reason must be at least 10 characters"
      reason: Invalid

    # --- UPDATE-only validations ---

    # Spec is immutable after creation
    - expression: >-
        !has(oldSelf) || object.spec == oldSelf.spec
      message: "spec is immutable after creation"
      reason: Invalid

    # State transitions: only allowed transitions
    # Valid: "" → Pending, Pending → {Approved, WaitingForScheduledTime, Rejected, Withdrawn, ApprovalTimeout}
    #        WaitingForScheduledTime → {Approved, Withdrawn}, Approved → Expired
    # Terminal states (Rejected, Withdrawn, Expired, ApprovalTimeout) cannot transition
    - expression: >-
        !has(oldSelf) ||
        !has(oldSelf.status) ||
        !has(oldSelf.status.state) ||
        oldSelf.status.state == "" ||
        oldSelf.status.state == object.status.state ||
        (oldSelf.status.state == "Pending" && object.status.state in ["Approved", "WaitingForScheduledTime", "Rejected", "Withdrawn", "ApprovalTimeout"]) ||
        (oldSelf.status.state == "WaitingForScheduledTime" && object.status.state in ["Approved", "Withdrawn"]) ||
        (oldSelf.status.state == "Approved" && object.status.state in ["Expired"])
      message: "invalid state transition"
      reason: Invalid
